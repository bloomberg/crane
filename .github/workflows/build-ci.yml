name: Build CI

on:
  - pull_request
  - push

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-24.04
        coq_version:
          - "9.0"
        ocaml_version:
          - "4.14-flambda"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build and Test
        uses: coq-community/docker-coq-action@v1
        with:
          opam_file: 'rocq-crane.opam'
          coq_version: ${{ matrix.coq_version }}
          ocaml_version: ${{ matrix.ocaml_version }}
          custom_script: |
            startGroup "Fix permissions"
              sudo chown -R $(id -u):$(id -g) .
            endGroup
            startGroup "Install clang-19 for C++23 support"
              sudo apt-get update
              sudo apt-get install -y wget lsb-release software-properties-common gnupg
              wget https://apt.llvm.org/llvm.sh
              chmod +x llvm.sh
              sudo ./llvm.sh 19
              sudo apt-get install -y libc++-19-dev libc++abi-19-dev clang-format-19
              sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 100
              sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 100
              sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-19 100
              clang++ --version
            endGroup
            startGroup "Install dependencies"
              opam pin add -n -y -k path rocq-crane .
              opam install -y -j 2 rocq-crane --deps-only --assume-depexts
            endGroup
            startGroup "Build project"
              opam exec -- dune build
              opam exec -- dune install
            endGroup
            startGroup "Run tests (excluding tests/wip)"
              TEST_DIRS=$(find tests -maxdepth 1 -mindepth 1 -type d ! -name wip | sort)
              echo "Running tests in: $TEST_DIRS"
              opam exec -- dune runtest $TEST_DIRS
            endGroup
